ARG BASE_JDK_IMAGE=mcr.microsoft.com/openjdk/jdk:25-ubuntu
ARG BASE_JRE_IMAGE=eclipse-temurin:25-jre-alpine
ARG IMAGE_VERSION=1.0.0
ARG IMAGE_NAME=spring-boot-app

# Stage 1: Prepare environment and download dependencies
FROM ${BASE_JDK_IMAGE} AS dependencies
# Use apt on Ubuntu-based image (apk is for Alpine)
RUN apt-get update && apt-get install -y maven && rm -rf /var/lib/apt/lists/*
WORKDIR /build
COPY pom.xml .
RUN mvn -B dependency:go-offline

# Stage 2: Build the application
FROM dependencies AS builder
WORKDIR /build
# Copy the full project into the build stage
COPY . .
# Use a non-interactive batch mode and skip tests for faster builds; remove -DskipTests if you want tests
RUN mvn -B package --no-transfer-progress -DskipTests

# Stage 3: Create the final runtime image
FROM ${BASE_JRE_IMAGE} AS runtime
WORKDIR /app
# Copy the produced JAR from the builder stage (wildcard is used to pick the built jar)
COPY --from=builder /build/target/*.jar app.jar
EXPOSE 8080
LABEL author="Sharif" \
      org.opencontainers.image.title="Spring Boot Application" \
      org.opencontainers.image.version="${IMAGE_VERSION}" \
      org.opencontainers.image.description="A Spring Boot application running on JDK 25" \
      org.opencontainers.image.licenses="MIT"
ENTRYPOINT ["java","-XX:MaxRAMPercentage=75.0", "-jar", "app.jar"]
